(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[177],{3673:()=>{},6251:(e,t,i)=>{"use strict";i.d(t,{AnalyticsProvider:()=>d});var n=i(5155),r=i(2115);function s(e,t,i,n){return new(i||(i=Promise))(function(r,s){function o(e){try{a(n.next(e))}catch(e){s(e)}}function l(e){try{a(n.throw(e))}catch(e){s(e)}}function a(e){var t;e.done?r(e.value):((t=e.value)instanceof i?t:new i(function(e){e(t)})).then(o,l)}a((n=n.apply(e,t||[])).next())})}function o(){return"undefined"!=typeof crypto&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{let t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}function l(){return Math.floor(Date.now()/1e3)}"function"==typeof SuppressedError&&SuppressedError;class a{constructor(e=!1){this.debug=e}log(...e){this.debug&&"undefined"!=typeof console&&console.log("[Analytics]",...e)}warn(...e){this.debug&&"undefined"!=typeof console&&console.warn("[Analytics]",...e)}error(...e){"undefined"!=typeof console&&console.error("[Analytics]",...e)}}class c{constructor(e){this.baseURL=e.baseURL.replace(/\/$/,""),this.timeout=e.timeout||1e4,this.headers=e.headers||{},this.logger=new a(e.debug),this.onError=e.onError}get(e,t){return s(this,void 0,void 0,function*(){let i=this.buildURL(e,t);return this.request("GET",i)})}post(e,t){return s(this,void 0,void 0,function*(){let i=this.buildURL(e);return this.request("POST",i,t)})}put(e,t){return s(this,void 0,void 0,function*(){let i=this.buildURL(e);return this.request("PUT",i,t)})}delete(e){return s(this,void 0,void 0,function*(){let t=this.buildURL(e);return this.request("DELETE",t)})}request(e,t,i){return s(this,void 0,void 0,function*(){let n=new AbortController,r=setTimeout(()=>n.abort(),this.timeout);try{let s;this.logger.log(`${e} ${t}`,i||"");let o={method:e,headers:Object.assign({"Content-Type":"application/json"},this.headers),signal:n.signal};i&&("POST"===e||"PUT"===e)&&(o.body=JSON.stringify(i));let l=yield fetch(t,o);clearTimeout(r);let a=l.headers.get("content-type");if(a&&a.includes("application/json"))s=yield l.json();else{let e=yield l.text();s={code:l.status,message:l.statusText,data:e}}if(!l.ok){let e=Error(s.message||`HTTP Error: ${l.status}`);return this.logger.error("Request failed:",e),this.onError&&this.onError(e),s}return this.logger.log("Response:",s),s}catch(i){clearTimeout(r);let e="Network request failed";"AbortError"===i.name?e="Request timeout":i.message&&(e=i.message),this.logger.error("Request error:",e);let t=Error(e);return this.onError&&this.onError(t),{code:-1,message:e}}})}buildURL(e,t){let i=`${this.baseURL}${e}`;if(t){let e=Object.keys(t).filter(e=>void 0!==t[e]&&null!==t[e]).map(e=>`${encodeURIComponent(e)}=${encodeURIComponent(t[e])}`).join("&");e&&(i+=`?${e}`)}return i}setHeader(e,t){this.headers[e]=t}removeHeader(e){delete this.headers[e]}}class u{constructor(e){this.eventQueue=[],this.isFlushing=!1,this.config=Object.assign(Object.assign({},{serverUrl:"",productName:"",deviceId:"",debug:!1,autoTrack:!0,batchSize:10,flushInterval:5e3,timeout:1e4,enableEncryption:!1,encryptionKey:"",onError:()=>{}}),e),this.logger=new a(this.config.debug),this.deviceId=this.config.deviceId||function(){let e="analytics_device_id";try{if("undefined"!=typeof localStorage){let t=localStorage.getItem(e);return t||(t=o(),localStorage.setItem(e,t)),t}}catch(e){}try{if("undefined"!=typeof document){let t=e+"=",i=decodeURIComponent(document.cookie).split(";");for(let e=0;e<i.length;e++){let n=i[e];for(;" "===n.charAt(0);)n=n.substring(1);if(0===n.indexOf(t))return n.substring(t.length,n.length)}let n=o(),r=new Date;return r.setFullYear(r.getFullYear()+10),document.cookie=`${e}=${n};expires=${r.toUTCString()};path=/`,n}}catch(e){}return o()}(),this.logger.log("Device ID:",this.deviceId),this.httpClient=new c({baseURL:this.config.serverUrl,timeout:this.config.timeout,debug:this.config.debug,onError:this.config.onError}),this.config.flushInterval>0&&this.startFlushTimer(),"undefined"!=typeof window&&window.addEventListener("beforeunload",()=>{this.flush(!0)}),this.logger.log("AnalyticsClient initialized",this.config)}track(e){return s(this,void 0,void 0,function*(){let t=Object.assign(Object.assign({},e),{product:this.config.productName,device_id:this.deviceId,timestamp:e.timestamp||l()});return this.logger.log("Tracking event:",t),this.eventQueue.push(t),!(this.eventQueue.length>=this.config.batchSize)||this.flush()})}trackEvent(e,t){return s(this,void 0,void 0,function*(){return this.track({name:e,properties:t})})}trackAction(e,t,i,n,r){return s(this,void 0,void 0,function*(){return this.track({name:`${e}_${t}`,category:e,action:t,label:i,value:n,properties:r})})}trackPageView(e,t,i){return s(this,void 0,void 0,function*(){return this.track({name:"page_view",category:"page",action:"view",label:e,properties:Object.assign({page_path:e,page_title:t||e},i)})})}reportInstall(e){return s(this,void 0,void 0,function*(){let t=function(){let e={};if("undefined"!=typeof navigator){e.user_agent=navigator.userAgent||"",e.language=navigator.language||"";let t=navigator.userAgent;if(/Windows/i.test(t)){e.os_name="Windows";let i=t.match(/Windows NT ([\d.]+)/);i&&(e.os_version=i[1])}else if(/Mac OS X/i.test(t)){e.os_name="macOS";let i=t.match(/Mac OS X ([\d_]+)/);i&&(e.os_version=i[1].replace(/_/g,"."))}else if(/Android/i.test(t)){e.os_name="Android";let i=t.match(/Android ([\d.]+)/);i&&(e.os_version=i[1])}else if(/iPhone|iPad|iPod/i.test(t)){e.os_name=/iPad/.test(t)?"iPad":"iPhone";let i=t.match(/OS ([\d_]+)/);i&&(e.os_version=i[1].replace(/_/g,"."))}else/Linux/i.test(t)&&(e.os_name="Linux");if(/iPhone/.test(t))e.device_brand="Apple",e.device_model="iPhone";else if(/iPad/.test(t))e.device_brand="Apple",e.device_model="iPad";else if(/Android/.test(t)){let i=t.match(/Android.*;\s*([^;)]+)\s+Build/);i&&(e.device_model=i[1].trim())}}if("undefined"!=typeof screen&&(e.screen_width=screen.width,e.screen_height=screen.height),"undefined"!=typeof Intl)try{e.timezone=Intl.DateTimeFormat().resolvedOptions().timeZone}catch(e){}return e}(),i=Object.assign(Object.assign({product:this.config.productName,device_id:this.deviceId,timestamp:l()},t),e);this.logger.log("Reporting install event:",i);let n=yield this.httpClient.post("/api/installs/push",i);return 200===n.code?this.logger.log("Install event reported successfully"):this.logger.error("Failed to report install event:",n.message),n})}verifyLicense(){return s(this,void 0,void 0,function*(){let e={product:this.config.productName,device_id:this.deviceId};this.logger.log("Verifying license:",e);let t=yield this.httpClient.post("/api/license/verify",e);return 200===t.code&&t.data?(this.logger.log("License verified:",t.data),t.data):(this.logger.error("License verification failed:",t.message),null)})}getLicense(){return s(this,void 0,void 0,function*(){let e={product:this.config.productName,device_id:this.deviceId};this.logger.log("Getting license info:",e);let t=yield this.httpClient.get("/api/license/get",e);return 200===t.code&&t.data?t.data:(this.logger.error("Failed to get license:",t.message),null)})}queryEvents(e){return s(this,void 0,void 0,function*(){let t=Object.assign({product:this.config.productName,device_id:this.deviceId},e);return this.logger.log("Querying events:",t),this.httpClient.get("/api/events/query",t)})}getStats(){return s(this,void 0,void 0,function*(){return this.logger.log("Getting stats"),this.httpClient.get("/api/stats")})}getEventStats(e,t){return s(this,void 0,void 0,function*(){let i={product:this.config.productName};return e&&(i.start_time=e),t&&(i.end_time=t),this.logger.log("Getting event stats:",i),this.httpClient.get("/api/events/stats",i)})}getEventTypes(){return s(this,void 0,void 0,function*(){let e={product:this.config.productName};return this.logger.log("Getting event types:",e),this.httpClient.get("/api/events/types",e)})}flush(){return s(this,arguments,void 0,function*(e=!1){if(this.isFlushing||0===this.eventQueue.length)return!0;this.isFlushing=!0;let t=[...this.eventQueue];this.eventQueue=[],this.logger.log(`Flushing ${t.length} events...`);try{let e=yield this.httpClient.post("/api/events/batch",{events:t});if(200===e.code)return this.logger.log("Events flushed successfully"),!0;return this.logger.error("Failed to flush events:",e.message),this.eventQueue.unshift(...t),!1}catch(e){return this.logger.error("Error flushing events:",e),this.eventQueue.unshift(...t),!1}finally{this.isFlushing=!1}})}startFlushTimer(){"undefined"!=typeof setInterval&&(this.flushTimer=setInterval(()=>{this.flush()},this.config.flushInterval))}stopFlushTimer(){this.flushTimer&&(clearInterval(this.flushTimer),this.flushTimer=void 0)}getDeviceId(){return this.deviceId}getProductName(){return this.config.productName}getQueueSize(){return this.eventQueue.length}destroy(){this.logger.log("Destroying AnalyticsClient"),this.stopFlushTimer(),this.flush(!0)}}class h{static initialize(e){return this.initialized&&this.instance&&(console.warn("[Analytics] Already initialized. Destroying previous instance."),this.instance.destroy()),this.instance=new u(e),this.initialized=!0,this.instance}static getInstance(){if(!this.instance)throw Error("[Analytics] Not initialized. Call Analytics.initialize() first.");return this.instance}static isInitialized(){return this.initialized&&null!==this.instance}static track(e,t){return s(this,void 0,void 0,function*(){return this.getInstance().trackEvent(e,t)})}static trackAction(e,t,i,n,r){return s(this,void 0,void 0,function*(){return this.getInstance().trackAction(e,t,i,n,r)})}static trackPageView(e,t,i){return s(this,void 0,void 0,function*(){return this.getInstance().trackPageView(e,t,i)})}static reportInstall(e){return s(this,void 0,void 0,function*(){return this.getInstance().reportInstall(e)})}static verifyLicense(){return s(this,void 0,void 0,function*(){return this.getInstance().verifyLicense()})}static flush(){return s(this,void 0,void 0,function*(){return this.getInstance().flush()})}static destroy(){this.instance&&(this.instance.destroy(),this.instance=null,this.initialized=!1)}}function d(e){let{children:t}=e;return(0,r.useEffect)(()=>{let e="https://go-analysis-proxy.vercel.app/proxy";if(e)try{h.initialize({serverUrl:e,productName:"BilibiliWeb",debug:!1,autoTrack:!0,batchSize:10,flushInterval:5e3,timeout:1e4,onError:e=>{}}),h.reportInstall({app_version:"0.1.0"}).catch(e=>{})}catch(e){}return()=>{try{h.flush()}catch(e){}}},[]),(0,n.jsx)(n.Fragment,{children:t})}h.instance=null,h.initialized=!1},7375:(e,t,i)=>{Promise.resolve().then(i.t.bind(i,3673,23)),Promise.resolve().then(i.bind(i,6251))}},e=>{e.O(0,[978,441,255,358],()=>e(e.s=7375)),_N_E=e.O()}]);